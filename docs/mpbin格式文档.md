### **.mpbin 文件格式规范 v1.0**

#### **1. 概述**

`.mpbin` 是一种二进制文件格式，用于高效地存储一个或多个粒子轨迹的动画数据。其设计目标是**快速加载**和**低内存占用**，通过预处理的二进制结构避免了运行时昂贵的文本解析。

文件采用 **大端序（Big-Endian）** 进行多字节数据的存储。

#### **2. 文件结构**

文件由三个主要部分组成：
1.  **文件头 (File Header)**: 提供文件的元数据，如文件类型、版本和动画的总体信息。
2.  **轨迹索引 (Track Index)**: 一个目录，列出了文件中包含的所有粒子轨迹及其基本信息，方便快速查找。
3.  **数据块 (Data Blocks)**: 紧凑排列的所有关键帧数据。

```
+---------------------------------+
|         文件头 (Header)         |
+---------------------------------+
|       轨迹索引 (Track Index)     |
|      (重复 track_count 次)      |
+---------------------------------+
|        数据块 (Data Blocks)      |
| (所有轨迹的关键帧数据连续存放)  |
+---------------------------------+
```

#### **3. 详细字段定义**

##### **3.1 文件头 (Header)**

| 偏移量 (Bytes) | 字段名        | 数据类型        | 长度 (Bytes) | 描述                                                                          |
| :------------- | :------------ | :-------------- | :----------- | :---------------------------------------------------------------------------- |
| 0              | `magic_number`  | `char[8]`       | 8            | 魔术字，用于识别文件类型。固定值为 ASCII 字符串 `"MPATICLE"`。                |
| 8              | `version`       | `uint32`        | 4            | 文件格式的版本号。当前版本为 **1**。                                           |
| 12             | `design_fps`    | `float32`       | 4            | 动画的设计帧率 (Frames Per Second)。例如 `30.0`, `60.0`。                      |
| 16             | `track_count`   | `uint32`        | 4            | 文件中包含的粒子轨迹（Particle Tracks）的总数量。                            |

*   **总长度**: 20 字节

##### **3.2 轨迹索引 (Track Index)**

文件头之后紧跟着轨迹索引块。此块由 `track_count` 个索引条目连续排列而成。

**每个索引条目的结构如下：**

| 偏移量 (Bytes)  | 字段名                | 数据类型        | 长度 (Bytes)      | 描述                                                                                              |
| :-------------- | :-------------------- | :-------------- | :---------------- | :------------------------------------------------------------------------------------------------ |
| 0               | `track_name_length`   | `uint32`        | 4                 | 轨迹名称的字节长度。                                                                              |
| 4               | `track_name`          | `char[]`        | `track_name_length` | 轨迹的名称，使用 **UTF-8** 编码。例如 `"left_wing_tip"`。                                        |
| 4 + len         | `keyframe_count`      | `uint32`        | 4                 | 该轨迹包含的关键帧（Keyframes）数量。                                                             |

*   **注意**: 索引中不包含数据偏移量。数据块是按照索引的顺序**连续排列**的。

##### **3.3 数据块 (Data Blocks)**

轨迹索引块之后，是所有轨迹的关键帧数据。数据按照轨迹在索引中出现的顺序，一个接一个地存放。

**例如，如果有两个轨迹 A 和 B，数据布局如下：**
`[轨迹A的所有关键帧] [轨迹B的所有关键帧]`

**每个关键帧（Keyframe）的结构如下：**

| 偏移量 (Bytes) | 字段名   | 数据类型  | 长度 (Bytes) | 描述                                       |
| :------------- | :------- | :-------- | :----------- | :----------------------------------------- |
| 0              | `tick`     | `int32`   | 4            | 关键帧所在的帧编号（基于 `design_fps`）。 |
| 4              | `pos_x`    | `float32` | 4            | 相对位置的 X 坐标。                         |
| 8              | `pos_y`    | `float32` | 4            | 相对位置的 Y 坐标。                         |
| 12             | `pos_z`    | `float32` | 4            | 相对位置的 Z 坐标。                         |
| 16             | `r`        | `uint8`   | 1            | 颜色：红色分量 (0-255)。                     |
| 17             | `g`        | `uint8`   | 1            | 颜色：绿色分量 (0-255)。                     |
| 18             | `b`        | `uint8`   | 1            | 颜色：蓝色分量 (0-255)。                     |
| 19             | `alpha`    | `uint8`   | 1            | 透明度 (0-255)。                            |
| 20             | `size`     | `float32` | 4            | 粒子的大小。                               |

*   **每个关键帧的总长度**: 24 字节
*   **前提条件**: 在写入文件前，**必须**确保每个轨迹内的关键帧已按 `tick` 从小到大排序。

#### **4. 示例：一个包含两个轨迹的 .mpbin 文件**

假设我们有如下动画数据：

*   **设计帧率**: 60.0 fps
*   **轨迹 1**:
    *   名称: `"main"`
    *   关键帧数量: 2
*   **轨迹 2**:
    *   名称: `"glow"`
    *   关键帧数量: 1

文件的二进制布局将会是：

```
// --- 文件头 (20 bytes) ---
[ "MPATICLE" (8) ] [ 1 (4) ] [ 60.0 (4) ] [ 2 (4) ]

// --- 轨迹索引 ---
// 索引 1 (4 + 4 + 4 = 12 bytes)
[ 4 (4) ] [ "main" (4) ] [ 2 (4) ]
// 索引 2 (4 + 4 + 4 = 12 bytes)
[ 4 (4) ] [ "glow" (4) ] [ 1 (4) ]

// --- 数据块 ---
// "main" 轨迹的数据 (2 * 24 = 48 bytes)
[ keyframe_1_data (24) ] [ keyframe_2_data (24) ]
// "glow" 轨迹的数据 (1 * 24 = 24 bytes)
[ keyframe_1_data (24) ]
```

#### **5. 数据类型映射**

| 规范类型  | Java (`DataOutputStream`) | Python (`struct`) | 描述             |
| :-------- | :------------------------ | :---------------- | :--------------- |
| `char[N]` | `writeBytes(String)`      | `Ns`              | 定长ASCII/UTF-8字符串 |
| `uint32`  | `writeInt(int)`           | `>I`              | 32位无符号整数   |
| `int32`   | `writeInt(int)`           | `>i`              | 32位有符号整数   |
| `float32` | `writeFloat(float)`       | `>f`              | 32位浮点数       |
| `uint8`   | `writeByte(int)`          | `>B`              | 8位无符号整数    |

*   **Python `struct` 格式字符串中的 `>` 表示使用大端序。**
